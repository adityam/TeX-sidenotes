%D \module
%D   [     file=caesar.tex, 
%D      version=0.55,
%D        title=caesar, 
%D     subtitle=sidenotes,
%D       author=Andy Thomas,
%D         date=120523, 
%D    copyright=Andy Thomas, 
%D      license=Public Domain]

\unprotect

% module code
% setup the page format
\definepapersize[wissenschaft][width=170mm,height=240mm]
% use the new page format
\setuppapersize[wissenschaft]
% shape the page layout
\setuplayout[topspace=40pt,
            header=0pt,
            headerdistance=0pt,
            backspace=42pt,
            leftmargin=0pt,
            width=280pt,
            height=560pt,
            rightmargindistance=20pt,
            rightmargin=100pt,
            footer=0pt]
% distinguish between verso and recto pages
\setuppagenumbering[alternative=doublesided]

% setup the side notes
\setupmargindata [margintext]
    [location=outer,
     width=100pt,
     align=flushouter,
     stack=continue,
     style={\tfx\setupinterlinespace[line=10pt]}]

\usemodule[annotation]

% setup the numbering of the side notes
\define[2]\AnnotationCommand 
{\high{\rawnumber[annotation]}% 
\margintext{\high{#1} #2\vskip4pt}} 

\defineannotation 
[annotation] 
[alternative=command, 
command=\AnnotationCommand, 
number=yes] 

%text across the full width of the page
\define[2]\FullwidthCommand 
{\doifoddpageelse 
{\doadaptrightskip{-120pt}} 
{\doadaptleftskip {-120pt}}% 
#2} 

\defineannotation 
[fullwidth] 
[alternative=command, 
command=\FullwidthCommand] 

% Enable old style numbers and protrusion
\definefontfeature[default][default][onum=yes, protrusion=quality, expansion=quality]

\starttypescript[mainface]
    \definetypeface [mainface] [rm] [serif] [pagella] [default]
    \definetypeface [mainface] [ss] [sans]  [heros]   [default]
    \definetypeface [mainface] [tt] [mono]  [cursor]  [default]
    \definetypeface [mainface] [mm] [math]  [pagella] [default]
\stoptypescript
\setupbodyfont[mainface,10pt]

% Enable protrusion
\setupalign[hz,hanging]

\setupindenting[10pt, yes]

%setup the headings
\setuphead[chapter][style=\tfd\it,
                    number=no,
                    before={\blank[5*big,force]},
                    after={\blank[4*big,force]}]
\setuphead[section][style=\tfb\it,
                    number=no]
\setuphead[subsection][style=\tfa\it,
                    number=no]
%the table of contents
\setuplist[chapter][style=\tfc\it,width=0pt,margin=0pt,before={\blank[2*big]}]

%setup the captions
\setupcaption[style={\tfx\setupinterlinespace[line=10pt]},headstyle=\rm,suffix={:}]

%use backspace as location anchor 
\setupfloats[indentnext=no,location=inner]

%
% High level macros start here

%setup the figures in 3 sizes
\define[2]\largefigure{\placefigure[here,top,bottom,page][#1]{#2}{\externalfigure[#1][width=400pt]}}%
\define[2]\normalfigure{\placefigure[here,top,bottom,page][#1]{#2}{\externalfigure[#1][width=280pt]}}%
\define[2]\smallfigure{\margintext{\placefigure[here][#1]{#2}{\externalfigure[#1][width=100pt]}}}%

%setup the tables in 3 sizes
\define[3]\largetable{\setupcaption[width=400pt]\placetable[here][#1]{#2}#3\setupcaption[width=fit]}
\define[3]\normaltable{\setupcaption[width=280pt]\placetable[here][#1]{#2}#3\setupcaption[width=fit]}
\define[3]\smalltable{\setupcaption[width=100pt]\margintext{\placetable[here][#1]{#2}#3}\setupcaption[width=fit]}

% put citations in the margin
\def\sidecite{\dodoubleempty\doSidecite}
\def\doSidecite[#1][#2]#3{\margintext{#1\cite[data][#3]#2}}

\setvariables
  [titlepage]
  [
    title=,
    author=,
    publisher=,
    set={\setups{caesar:titlepage}},
  ]

\startsetups caesar:titlepage
    {\ssc\noindent\kerncharacters[0.125]\WORD{\getvariable{titlepage}{author}}\endgraf}
    \blank[100pt]
    {\setupbodyfont[sansserif,38pt]\setupinterlinespace[line=50pt]
     \noindentation\kerncharacters[0.15]\WORD{\getvariable{titlepage}{title}}\endgraf}
    \vfill
    {\ss\tfc\kerncharacters[0.125]\WORD{\getvariable{titlepage}{publisher}}\endgraf}
\stopsetups

\protect \endinput
