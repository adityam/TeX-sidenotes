%D \module
%D   [     file=caesar.tex, 
%D      version=0.55,
%D        title=caesar, 
%D     subtitle=sidenotes,
%D       author=Andy Thomas,
%D         date=120523, 
%D    copyright=Andy Thomas, 
%D      license=Public Domain]

\unprotect

\definepapersize[wissenschaft][width=170mm, height=240mm]
\setuppapersize [wissenschaft]

\setuplayout[topspace=40pt,
             header=0pt,
             headerdistance=0pt,
             height=560pt,
             footer=0pt,
             %
             backspace=42pt,
             leftmargin=0pt,
             width=280pt,
             rightmargindistance=20pt,
             rightmargin=100pt]

% doublesided layout to get different verso and recto pages
\setuppagenumbering[alternative=doublesided]

% setup the side notes
\setupmargindata
    [margintext]
    [location=outer,
     width=100pt,
     align=flushouter,
     stack=continue,
     style={\tfx\setupinterlinespace[line=10pt]}]

\usemodule[annotation]

% setup the numbering of the side notes
\define[2]\caesar_annotation_command 
    {\high{\rawnumber[annotation]}% 
     \margintext{\high{#1} #2\vskip4pt}} 

\defineannotation 
    [annotation] 
    [alternative=command, 
     command=\caesar_annotation_command, 
     number=yes] 

\definemeasure
    [fullwidth_extra]
    [\the\dimexpr\layoutparameter\c!rightmargin + \layoutparameter\c!rightmargindistance]

% text across the full width of the page
\define[1]\caesar_fullwidth_command 
    {\doifoddpageelse 
        {\doadaptrightskip{-\measure{fullwidth_extra}}} 
        {\doadaptleftskip {-\measure{fullwidth_extra}}}} %#2 

\defineannotation 
    [fullwidth] 
    [alternative=command, 
     command=\caesar_fullwidth_command] 

% put citations in the margin
\unexpanded\def\sidecite{\dodoubleargument\sidecite_indeed}
\def\sidecite_indeed[#1][#2]%
    {\getparameters[caesar_sidecite_][left=,right=,#1]%
      \margintext
          {\caesar_sidecite_left
           \cite[data][#2]%
           \caesar_sidecite_right}}

% Enable old style numbers and protrusion
\definefontfeature[default][default][onum=yes, protrusion=quality, expansion=quality]

\starttypescript[mainface]
    \definetypeface [mainface] [rm] [serif] [pagella] [default]
    \definetypeface [mainface] [ss] [sans]  [heros]   [default]
    \definetypeface [mainface] [tt] [mono]  [cursor]  [default]
    \definetypeface [mainface] [mm] [math]  [pagella] [default]
\stoptypescript
\setupbodyfont[mainface,10pt]

% Enable protrusion
\setupalign[hz,hanging]

\setupindenting[10pt, yes]

% setup the headings
\setuphead[chapter]
          [
            style=\itd,
            number=no,
            before={\blank[5*big,force]},
            after={\blank[4*big,force]},
          ]

\setuphead[section]
          [style=\itb,
           number=no]

\setuphead[subsection]
          [style=\ita,
           number=no]

%the table of contents
\setuplist
  [chapter]
  [
    style=\itc,
    width=0pt, 
    margin=0pt, 
    before={\blank[2*big]},
  ]

% setup the captions
\setupcaption[style={\tfx\setupinterlinespace[line=10pt]}, headstyle=\rm, suffix={:}]

\defineexternalfigure[margin]   [width=\layoutparameter\c!rightmargin]
\defineexternalfigure[textwidth][width=\textwidth]
\defineexternalfigure[fullwidth][width=\the\dimexpr\textwidth+\measure{fullwidth_extra}\relax]

\setupfloat[figure][indentnext=no, location={here,top,bottom,page}]


%setup the figures in 3 sizes
\define[2]\largefigure{\placefigure[here,top,bottom,page][#1]{#2}{\externalfigure[#1][fullwidth]}}%
\define[2]\smallfigure{\margintext{\placefigure[here][#1]{#2}{\externalfigure[#1][margin]}}}%

%setup the tables in 3 sizes
\define[3]\largetable{\setupcaption[width=400pt]\placetable[here][#1]{#2}#3\setupcaption[width=fit]}
\define[3]\normaltable{\setupcaption[width=280pt]\placetable[here][#1]{#2}#3\setupcaption[width=fit]}
\define[3]\smalltable{\setupcaption[width=100pt]\margintext{\placetable[here][#1]{#2}#3}\setupcaption[width=fit]}

\setvariables
  [titlepage]
  [
    title=,
    author=,
    publisher=,
    set={\setups{caesar:titlepage}},
  ]

\startsetups caesar:titlepage
    {\ssc\noindent\kerncharacters[0.125]\WORD{\getvariable{titlepage}{author}}\endgraf}
    \blank[100pt]
    {\setupbodyfont[sansserif,38pt]\setupinterlinespace[line=50pt]
     \noindentation\kerncharacters[0.15]\WORD{\getvariable{titlepage}{title}}\endgraf}
    \vfill
    {\ss\tfc\kerncharacters[0.125]\WORD{\getvariable{titlepage}{publisher}}\endgraf}
\stopsetups

\protect \endinput
